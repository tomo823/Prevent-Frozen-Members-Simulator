<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swarm Intelligence - Online Discussion Group Simulation</title>
    <!-- p5.js ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ - æç”»ã¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã«ä½¿ç”¨ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <style>
        /* ============================================
           CSS ã‚¹ã‚¿ã‚¤ãƒ«å®šç¾©
           - å…¨ä½“ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¨ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’è¨­å®š
        ============================================ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
            padding: 10px;
        }
        /* ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ†ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .header { text-align: center; margin-bottom: 6px; }
        .header h1 { font-size: 1rem; color: #00d4ff; }
        .header p { font-size: 0.65rem; color: #888; }
        
        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ - 3åˆ—ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆå·¦ãƒ‘ãƒãƒ«ã€ä¸­å¤®ã€å³ãƒ‘ãƒãƒ«ï¼‰ */
        .main-container { display: flex; gap: 8px; max-width: 1400px; margin: 0 auto; }
        .left-panel { width: 260px; display: flex; flex-direction: column; gap: 6px; }
        .center-area { flex: 1; display: flex; flex-direction: column; gap: 6px; }
        #simulation-canvas { background: #0f0f1a; border-radius: 6px; }
        /* ã‚°ãƒ©ãƒ•ã‚­ãƒ£ãƒ³ãƒã‚¹ - é«˜DPIãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤å¯¾å¿œã®ãŸã‚widthã¨heightã‚’CSSã§å›ºå®š */
        #graph-canvas { background: #0f0f1a; border-radius: 6px; border: 1px solid #2a3a5e; width: 640px; height: 160px; }
        .right-panel { width: 210px; display: flex; flex-direction: column; gap: 6px; }
        
        /* ãƒ‘ãƒãƒ«å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
        .panel { background: #16213e; border-radius: 5px; padding: 6px; }
        .panel h3 { color: #00d4ff; font-size: 0.7rem; margin-bottom: 5px; border-bottom: 1px solid #2a3a5e; padding-bottom: 3px; }
        
        /* æ¬¡å…ƒãƒãƒ¼ï¼ˆãƒˆãƒ”ãƒƒã‚¯ã®å„æ¬¡å…ƒã®é‡ã¿ã‚’è¡¨ç¤ºï¼‰ */
        .dimension-bar { display: flex; align-items: center; margin-bottom: 2px; font-size: 0.5rem; }
        .dimension-bar .label { width: 55px; color: #888; }
        .dimension-bar .bar-track { flex: 1; height: 6px; background: #2a3a5e; border-radius: 3px; overflow: hidden; margin: 0 3px; }
        .dimension-bar .bar-fill { height: 100%; border-radius: 3px; }
        .dimension-bar .value { width: 24px; text-align: right; color: #00d4ff; font-size: 0.45rem; }
        
        /* ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆè¡¨ç¤º */
        .member-list { max-height: 150px; overflow-y: auto; font-size: 0.5rem; }
        .member-item {
            display: grid;
            grid-template-columns: 24px 40px 1fr 38px 18px;
            align-items: center;
            padding: 2px 3px;
            margin-bottom: 1px;
            background: #1a2744;
            border-radius: 2px;
            gap: 2px;
            border-left: 2px solid transparent;
        }
        /* ãƒ¡ãƒ³ãƒãƒ¼ã®èˆˆå‘³ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ãŸè‰²åˆ†ã‘ */
        .member-item.high-interest { border-left-color: #4ecdc4; background: #1a3744; }
        .member-item.low-interest { border-left-color: #ff6b6b; background: #2a1a24; }
        .member-item.left-out { background: #3a1a1a; border-left-color: #ff4444; }
        .member-item .interest-bar { height: 5px; background: #2a3a5e; border-radius: 2px; overflow: hidden; }
        .member-item .interest-fill { height: 100%; border-radius: 2px; }
        
        /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ç­‰ï¼‰ */
        .control-group { margin-bottom: 4px; }
        .control-group label { display: block; font-size: 0.55rem; color: #aaa; margin-bottom: 1px; }
        .control-group input[type="range"] { width: 100%; height: 3px; -webkit-appearance: none; background: #2a3a5e; border-radius: 2px; }
        .control-group input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 8px; height: 8px; background: #00d4ff; border-radius: 50%; cursor: pointer; }
        .control-group .value { text-align: right; font-size: 0.5rem; color: #00d4ff; }
        
        /* ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
        .btn { width: 100%; padding: 4px; border: none; border-radius: 3px; cursor: pointer; font-size: 0.6rem; font-weight: 600; margin-bottom: 2px; }
        .btn-primary { background: linear-gradient(135deg, #00d4ff, #0099cc); color: #fff; }
        .btn-secondary { background: #2a3a5e; color: #ddd; }
        .btn-danger { background: #aa3333; color: #fff; }
        
        /* çµ±è¨ˆè¡¨ç¤ºã‚°ãƒªãƒƒãƒ‰ */
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 3px; }
        .stat-item { background: #1a2744; padding: 3px; border-radius: 3px; text-align: center; }
        .stat-item .value { font-size: 0.8rem; font-weight: bold; color: #00d4ff; }
        .stat-item .value.danger { color: #ff4444; }
        .stat-item .label { font-size: 0.45rem; color: #888; }
        
        /* ã‚°ãƒ«ãƒ¼ãƒ—é¸æŠãƒœã‚¿ãƒ³ */
        .group-selector { display: flex; gap: 2px; margin-bottom: 5px; }
        .group-btn { flex: 1; padding: 3px; border: 2px solid transparent; border-radius: 3px; cursor: pointer; font-size: 0.55rem; font-weight: bold; }
        .group-btn.active { border-color: #fff; }
        .group-btn.g1 { background: #ff6b35; color: #fff; }
        .group-btn.g2 { background: #4ecdc4; color: #fff; }
        .group-btn.g3 { background: #95e86f; color: #000; }
        .group-btn.g4 { background: #ffd93d; color: #000; }
        
        /* ãƒˆãƒ”ãƒƒã‚¯æƒ…å ±ã‚«ãƒ¼ãƒ‰ */
        .topic-card { background: #1a2744; padding: 5px; border-radius: 3px; margin-bottom: 5px; }
        .topic-card .topic-name { font-size: 0.7rem; font-weight: bold; color: #fff; margin-bottom: 3px; }
        .topic-card .topic-category { font-size: 0.55rem; color: #888; margin-bottom: 3px; }
        
        /* æ•°å¼è¡¨ç¤ºãƒœãƒƒã‚¯ã‚¹ */
        .equation-box { background: #1a1a2a; border: 1px solid #3a3a5a; padding: 4px; border-radius: 3px; font-size: 0.5rem; font-family: monospace; margin-bottom: 5px; }
        .equation-box .highlight { color: #ff6b6b; }
        
        /* ã‚°ãƒ©ãƒ•å‡¡ä¾‹ */
        .legend-item { display: inline-flex; align-items: center; margin-right: 6px; font-size: 0.45rem; }
        .legend-color { width: 8px; height: 8px; border-radius: 2px; margin-right: 2px; }
        
        .graph-title { font-size: 0.7rem; color: #00d4ff; margin-bottom: 4px; }
    </style>
</head>
<body>
    <!-- ============================================
         HTMLãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæ§‹é€ 
         - ãƒ˜ãƒƒãƒ€ãƒ¼: ã‚¿ã‚¤ãƒˆãƒ«ã¨èª¬æ˜
         - ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ: 3åˆ—ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
    ============================================ -->
    <div class="header">
        <h1>Swarm Intelligence: Dynamic Tracking of Members' Interests</h1>
        <p>Group halts when &lt;3 active members â€¢ Graph shows interest fluctuation like Figure 5</p>
    </div>
    
    <div class="main-container">
        <!-- å·¦ãƒ‘ãƒãƒ«: ãƒˆãƒ”ãƒƒã‚¯æƒ…å ±ã€ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã€ãƒ­ã‚°è¡¨ç¤º -->
        <div class="left-panel">
            <div class="panel">
                <h3>ğŸ“ Current Topic</h3>
                <!-- ã‚°ãƒ«ãƒ¼ãƒ—é¸æŠãƒœã‚¿ãƒ³ (G1-G4) -->
                <div class="group-selector">
                    <button class="group-btn g1 active" data-group="0">G1</button>
                    <button class="group-btn g2" data-group="1">G2</button>
                    <button class="group-btn g3" data-group="2">G3</button>
                    <button class="group-btn g4" data-group="3">G4</button>
                </div>
                <!-- ç¾åœ¨ã®ãƒˆãƒ”ãƒƒã‚¯æƒ…å ±è¡¨ç¤º -->
                <div class="topic-card">
                    <div class="topic-name" id="topic-name">Loading...</div>
                    <div class="topic-category" id="topic-category">-</div>
                    <div id="topic-dimensions"></div>
                </div>
            </div>
            
            <!-- ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§ãƒ‘ãƒãƒ« -->
            <div class="panel">
                <h3>ğŸ‘¥ Members</h3>
                <!-- æ•°å¼è¡¨ç¤º: é›¢è„±åˆ¤å®šã®æ¡ä»¶ -->
                <div class="equation-box">
                    <strong>v<sub>G</sub></strong> = <span id="vg-display">0.00</span> | 
                    <strong>vâ‚€</strong> = <span id="v0-display">1.00</span><br>
                    <span class="highlight">Frozen if: v<sub>G</sub> - v<sub>i</sub> > vâ‚€</span>
                </div>
                <div id="member-list" class="member-list"></div>
            </div>
            
            <!-- é›¢è„±ãƒ¡ãƒ³ãƒãƒ¼ã®ãƒ­ã‚° -->
            <div class="panel">
                <h3>ğŸ“œ Left-Out Log</h3>
                <div id="leftout-log" style="font-size:0.45rem; color:#ff8888; max-height:50px; overflow-y:auto;">Waiting...</div>
            </div>
            
            <!-- ã‚°ãƒ©ãƒ•ã®å‡¡ä¾‹ -->
            <div class="panel">
                <h3>ğŸ“Š Graph Legend</h3>
                <div id="graph-legend" style="font-size:0.5rem; line-height: 1.6;"></div>
            </div>
        </div>
        
        <!-- ä¸­å¤®ã‚¨ãƒªã‚¢: ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚­ãƒ£ãƒ³ãƒã‚¹ã¨ã‚°ãƒ©ãƒ• -->
        <div class="center-area">
            <div id="canvas-container"></div>
            <div class="graph-title">ğŸ“ˆ Members' Interest Fluctuation Over Topic Transitions (Selected Group)</div>
            <!-- ã‚°ãƒ©ãƒ•æç”»ç”¨ã‚­ãƒ£ãƒ³ãƒã‚¹ï¼ˆvanilla JSã§æç”»ï¼‰ -->
            <canvas id="graph-canvas"></canvas>
        </div>
        
        <!-- å³ãƒ‘ãƒãƒ«: çµ±è¨ˆæƒ…å ±ã¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
        <div class="right-panel">
            <!-- çµ±è¨ˆæƒ…å ±ãƒ‘ãƒãƒ« -->
            <div class="panel">
                <h3>ğŸ“Š Statistics</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="value" id="total-active">40</div>
                        <div class="label">Active</div>
                    </div>
                    <div class="stat-item">
                        <div class="value danger" id="total-leftout">0</div>
                        <div class="label">â„ï¸ Frozen</div>
                    </div>
                    <div class="stat-item">
                        <div class="value" id="topic-changes">0</div>
                        <div class="label">Transitions</div>
                    </div>
                </div>
                <div style="margin-top:4px; font-size:0.5rem; color:#888;">
                    Halted groups: <strong id="halted-count" style="color:#f44">0</strong>
                </div>
            </div>
            
            <!-- é›¢è„±æ¤œå‡ºãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ -->
            <div class="panel">
                <h3>â„ï¸ Left-Out Detection</h3>
                <div class="control-group">
                    <label>Threshold vâ‚€</label>
                    <input type="range" id="threshold" min="0.3" max="3" value="1.0" step="0.1">
                    <div class="value" id="threshold-val">1.00</div>
                </div>
                <div class="control-group">
                    <label>Check frequency</label>
                    <input type="range" id="check-freq" min="20" max="150" value="45" step="5">
                    <div class="value" id="check-freq-val">45</div>
                </div>
                <button class="btn btn-danger" id="force-check-btn">âš¡ Force Check</button>
            </div>
            
            <!-- Boidsã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ -->
            <div class="panel">
                <h3>âš™ï¸ Boids</h3>
                <div class="control-group">
                    <label>Cohesion</label>
                    <input type="range" id="cohesion" min="0" max="4" value="2.0" step="0.1">
                    <div class="value" id="cohesion-val">2.0</div>
                </div>
                <div class="control-group">
                    <label>Alignment</label>
                    <input type="range" id="alignment" min="0" max="2" value="0.8" step="0.1">
                    <div class="value" id="alignment-val">0.8</div>
                </div>
                <div class="control-group">
                    <label>Separation</label>
                    <input type="range" id="separation" min="0" max="2" value="1.0" step="0.1">
                    <div class="value" id="separation-val">1.0</div>
                </div>
                <div class="control-group">
                    <label>Interest Pull</label>
                    <input type="range" id="interest-pull" min="0" max="1.5" value="0.5" step="0.05">
                    <div class="value" id="interest-pull-val">0.5</div>
                </div>
            </div>
            
            <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ -->
            <div class="panel">
                <h3>ğŸ® Controls</h3>
                <button class="btn btn-primary" id="mode-btn">ğŸ”„ Switch to 1 Group</button>
                <button class="btn btn-secondary" id="restart-btn">ğŸ”„ Restart</button>
                <button class="btn btn-secondary" id="pause-btn">â¸ï¸ Pause</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // è¨­å®šå®šæ•° (CONFIG)
        // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®åŸºæœ¬ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å®šç¾©
        // ============================================
        const CONFIG = {
            groupSize: 10,          // å„ã‚°ãƒ«ãƒ¼ãƒ—ã®ãƒ¡ãƒ³ãƒãƒ¼æ•°
            numGroups: 4,           // ã‚°ãƒ«ãƒ¼ãƒ—æ•°ï¼ˆ4ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¢ãƒ¼ãƒ‰æ™‚ï¼‰
            numDimensions: 6,       // ãƒˆãƒ”ãƒƒã‚¯ã®æ¬¡å…ƒæ•°ï¼ˆKæ¬¡å…ƒãƒ™ã‚¯ãƒˆãƒ«ï¼‰
            
            // 6ã¤ã®æ¬¡å…ƒã®åå‰ï¼ˆè«–æ–‡ã®ã€Œè¦–ç‚¹ã€ã«ç›¸å½“ï¼‰
            dimensionNames: ['Politics', 'Tech', 'Sports', 'Science', 'Religion', 'Commerce'],
            
            // å„æ¬¡å…ƒã®è¡¨ç¤ºè‰²
            dimensionColors: ['#e74c3c', '#3498db', '#27ae60', '#9b59b6', '#f39c12', '#1abc9c'],
            
            maxVelocity: 10,        // æœ€å¤§é€Ÿåº¦ Vmaxï¼ˆå¼5ã§ä½¿ç”¨ï¼‰
            maxInterest: 10,        // æœ€å¤§èˆˆå‘³ãƒ¬ãƒ™ãƒ« Lmaxï¼ˆå¼5ã§ä½¿ç”¨ï¼‰
            
            // ã‚°ãƒ«ãƒ¼ãƒ—ã®è¡¨ç¤ºè‰²
            groupColors: ['#ff6b35', '#4ecdc4', '#95e86f', '#ffd93d'],
            groupNames: ['G1', 'G2', 'G3', 'G4'],
            
            // ãƒ¡ãƒ³ãƒãƒ¼ã®å€‹åˆ¥è‰²ï¼ˆã‚°ãƒ©ãƒ•è¡¨ç¤ºç”¨ï¼‰
            memberColors: [
                '#ff6b6b', '#4ecdc4', '#ffe66d', '#95e86f', '#ff9ff3',
                '#54a0ff', '#ff9f43', '#a55eea', '#26de81', '#fd79a8'
            ],
            
            minActiveMembers: 3     // ã‚°ãƒ«ãƒ¼ãƒ—åœæ­¢æ¡ä»¶ï¼šã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¡ãƒ³ãƒãƒ¼ãŒã“ã®æ•°æœªæº€ã§åœæ­¢
        };

        // ============================================
        // 20 Newsgroups ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã«åŸºã¥ããƒˆãƒ”ãƒƒã‚¯å®šç¾©
        // å„ãƒˆãƒ”ãƒƒã‚¯ã¯6æ¬¡å…ƒã®é‡ã¿ãƒ™ã‚¯ãƒˆãƒ«ã§è¡¨ç¾ï¼ˆå¼1ã«å¯¾å¿œï¼‰
        // weightsé…åˆ—: [Politics, Tech, Sports, Science, Religion, Commerce]
        // ============================================
        const NEWSGROUP_TOPICS = [
            // æ”¿æ²»ç³»ãƒˆãƒ”ãƒƒã‚¯ï¼ˆPoliticsæ¬¡å…ƒãŒé«˜ã„ï¼‰
            { name: 'talk.politics.misc', weights: [0.65, 0.05, 0.02, 0.08, 0.10, 0.10] },
            { name: 'talk.politics.guns', weights: [0.55, 0.08, 0.05, 0.02, 0.15, 0.15] },
            { name: 'talk.politics.mideast', weights: [0.50, 0.05, 0.02, 0.05, 0.30, 0.08] },
            
            // æŠ€è¡“ç³»ãƒˆãƒ”ãƒƒã‚¯ï¼ˆTechæ¬¡å…ƒãŒé«˜ã„ï¼‰
            { name: 'comp.graphics', weights: [0.02, 0.70, 0.02, 0.18, 0.02, 0.06] },
            { name: 'comp.os.ms-windows', weights: [0.03, 0.72, 0.02, 0.10, 0.02, 0.11] },
            { name: 'comp.sys.mac.hardware', weights: [0.02, 0.68, 0.02, 0.12, 0.02, 0.14] },
            { name: 'comp.windows.x', weights: [0.02, 0.75, 0.02, 0.13, 0.02, 0.06] },
            
            // ã‚¹ãƒãƒ¼ãƒ„ç³»ãƒˆãƒ”ãƒƒã‚¯ï¼ˆSportsæ¬¡å…ƒãŒé«˜ã„ï¼‰
            { name: 'rec.sport.baseball', weights: [0.05, 0.03, 0.70, 0.02, 0.02, 0.18] },
            { name: 'rec.sport.hockey', weights: [0.04, 0.03, 0.72, 0.02, 0.02, 0.17] },
            { name: 'rec.autos', weights: [0.05, 0.15, 0.45, 0.10, 0.02, 0.23] },
            { name: 'rec.motorcycles', weights: [0.04, 0.12, 0.48, 0.08, 0.02, 0.26] },
            
            // ç§‘å­¦ç³»ãƒˆãƒ”ãƒƒã‚¯ï¼ˆScienceæ¬¡å…ƒãŒé«˜ã„ï¼‰
            { name: 'sci.space', weights: [0.10, 0.18, 0.02, 0.60, 0.02, 0.08] },
            { name: 'sci.med', weights: [0.08, 0.12, 0.05, 0.58, 0.05, 0.12] },
            { name: 'sci.electronics', weights: [0.03, 0.30, 0.02, 0.52, 0.02, 0.11] },
            { name: 'sci.crypt', weights: [0.12, 0.28, 0.02, 0.48, 0.02, 0.08] },
            
            // å®—æ•™ç³»ãƒˆãƒ”ãƒƒã‚¯ï¼ˆReligionæ¬¡å…ƒãŒé«˜ã„ï¼‰
            { name: 'soc.religion.christian', weights: [0.15, 0.02, 0.02, 0.03, 0.70, 0.08] },
            { name: 'talk.religion.misc', weights: [0.18, 0.03, 0.02, 0.05, 0.65, 0.07] },
            { name: 'alt.atheism', weights: [0.20, 0.05, 0.02, 0.15, 0.50, 0.08] },
            
            // å•†æ¥­ç³»ãƒˆãƒ”ãƒƒã‚¯ï¼ˆCommerceæ¬¡å…ƒãŒé«˜ã„ï¼‰
            { name: 'misc.forsale', weights: [0.05, 0.15, 0.10, 0.05, 0.02, 0.63] },
            { name: 'rec.autos.marketplace', weights: [0.03, 0.10, 0.25, 0.05, 0.02, 0.55] },
        ];

        // ============================================
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹ã‚’ç®¡ç†
        // ============================================
        let groups = [];                    // ã‚°ãƒ«ãƒ¼ãƒ—ã®é…åˆ—
        let selectedGroupId = 0;            // ç¾åœ¨é¸æŠä¸­ã®ã‚°ãƒ«ãƒ¼ãƒ—ID
        let paused = false;                 // ä¸€æ™‚åœæ­¢ãƒ•ãƒ©ã‚°
        let totalTopicChanges = 0;          // ãƒˆãƒ”ãƒƒã‚¯é·ç§»ã®ç·æ•°
        let leftOutLog = [];                // é›¢è„±ãƒ­ã‚°
        let singleGroupMode = false;        // ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿: false=4ã‚°ãƒ«ãƒ¼ãƒ—, true=1ã‚°ãƒ«ãƒ¼ãƒ—

        // ============================================
        // Boidsã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
        // UIã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§èª¿æ•´å¯èƒ½
        // ============================================
        let cohesionWeight = 2.0;           // çµåˆåŠ›ã®é‡ã¿ï¼ˆç¾¤ã‚Œã®ä¸­å¿ƒã«å‘ã‹ã†åŠ›ï¼‰
        let alignmentWeight = 0.8;          // æ•´åˆ—åŠ›ã®é‡ã¿ï¼ˆéš£æ¥å€‹ä½“ã¨åŒã˜æ–¹å‘ã«å‘ã‹ã†åŠ›ï¼‰
        let separationWeight = 1.0;         // åˆ†é›¢åŠ›ã®é‡ã¿ï¼ˆè¿‘ã™ãã‚‹å€‹ä½“ã‹ã‚‰é›¢ã‚Œã‚‹åŠ›ï¼‰
        let interestPullWeight = 0.5;       // èˆˆå‘³ã«ã‚ˆã‚‹å¼•åŠ›ã®é‡ã¿
        
        // é›¢è„±æ¤œå‡ºãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
        let leftOutThreshold = 1.0;         // é›¢è„±åˆ¤å®šé–¾å€¤ vâ‚€ï¼ˆå¼7ã§ä½¿ç”¨ï¼‰
        let leftOutCheckFrequency = 45;     // é›¢è„±ãƒã‚§ãƒƒã‚¯é »åº¦ï¼ˆãƒ•ãƒ¬ãƒ¼ãƒ æ•°ï¼‰
        
        // æ¢ç´¢ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
        let heatDecayRate = 0.008;          // ãƒ’ãƒ¼ãƒˆæ¸›è¡°ç‡ï¼ˆè¨ªå•æ¸ˆã¿ãƒˆãƒ”ãƒƒã‚¯ã®ç†±ãŒå†·ã‚ã‚‹é€Ÿåº¦ï¼‰
        let momentumWeight = 0.3;           // ãƒ¢ãƒ¡ãƒ³ã‚¿ãƒ ã®é‡ã¿ï¼ˆæ…£æ€§ã®å¼·ã•ï¼‰

        // ============================================
        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        // ============================================
        
        /**
         * Kæ¬¡å…ƒãƒ™ã‚¯ãƒˆãƒ«ã‚’2Dåº§æ¨™ã«å°„å½±ã™ã‚‹é–¢æ•°
         * å„æ¬¡å…ƒã‚’å††å‘¨ä¸Šã®è§’åº¦ã«å¯¾å¿œã•ã›ã¦2Dåº§æ¨™ã‚’è¨ˆç®—
         * ãƒˆãƒ”ãƒƒã‚¯ã®ç©ºé–“é…ç½®ã«ä½¿ç”¨ï¼ˆé¡ä¼¼ãƒˆãƒ”ãƒƒã‚¯ã‚’è¿‘ãã«é…ç½®ï¼‰
         * 
         * @param {Array} vector - Kæ¬¡å…ƒã®é‡ã¿ãƒ™ã‚¯ãƒˆãƒ«
         * @returns {Object} {x, y} - 2Dåº§æ¨™
         */
        function projectTo2D(vector) {
            let x = 0, y = 0;
            const K = vector.length;
            for (let k = 0; k < K; k++) {
                // å„æ¬¡å…ƒkã‚’è§’åº¦ 2Ï€k/K ã«å¯¾å¿œã•ã›ã‚‹
                let angle = (k / K) * Math.PI * 2;
                x += vector[k] * Math.cos(angle);
                y += vector[k] * Math.sin(angle);
            }
            return { x, y };
        }

        /**
         * ãƒˆãƒ”ãƒƒã‚¯ã‚’ãƒ™ã‚¯ãƒˆãƒ«é¡ä¼¼åº¦ã«åŸºã¥ã„ã¦ã‚°ãƒªãƒƒãƒ‰ã«é…ç½®ã™ã‚‹é–¢æ•°
         * é¡ä¼¼ã—ãŸãƒˆãƒ”ãƒƒã‚¯ãŒéš£æ¥ã™ã‚‹ã‚ˆã†ã«é…ç½®
         * 
         * @param {Array} topics - ãƒˆãƒ”ãƒƒã‚¯ã®é…åˆ—
         * @param {number} cols - ã‚°ãƒªãƒƒãƒ‰ã®åˆ—æ•°
         * @param {number} rows - ã‚°ãƒªãƒƒãƒ‰ã®è¡Œæ•°
         * @returns {Array} é…ç½®çµæœã®é…åˆ—
         */
        function arrangeTopicsByProjection(topics, cols, rows) {
            // Step 1: å…¨ãƒˆãƒ”ãƒƒã‚¯ã‚’2Dã«å°„å½±
            let projected = topics.map((t, i) => ({
                originalIndex: i, topic: t, pos: projectTo2D(t.weights)
            }));
            
            // Step 2: åº§æ¨™ã®æ­£è¦åŒ–ï¼ˆ0-1ã®ç¯„å›²ã«ï¼‰
            let minX = Math.min(...projected.map(p => p.pos.x));
            let maxX = Math.max(...projected.map(p => p.pos.x));
            let minY = Math.min(...projected.map(p => p.pos.y));
            let maxY = Math.max(...projected.map(p => p.pos.y));
            
            const rangeX = maxX - minX || 1;
            const rangeY = maxY - minY || 1;
            projected.forEach(p => {
                p.normX = (p.pos.x - minX) / rangeX;
                p.normY = (p.pos.y - minY) / rangeY;
            });
            
            // Step 3: ã‚°ãƒªãƒƒãƒ‰ä½ç½®ã§ã‚½ãƒ¼ãƒˆ
            let result = [];
            let occupied = new Set();
            
            projected.sort((a, b) => {
                let aCol = Math.floor(a.normX * cols * 0.999);
                let aRow = Math.floor(a.normY * rows * 0.999);
                let bCol = Math.floor(b.normX * cols * 0.999);
                let bRow = Math.floor(b.normY * rows * 0.999);
                if (aRow !== bRow) return aRow - bRow;
                return aCol - bCol;
            });
            
            // Step 4: å„ãƒˆãƒ”ãƒƒã‚¯ã‚’æœ€ã‚‚è¿‘ã„ç©ºãã‚»ãƒ«ã«é…ç½®ï¼ˆã‚¹ãƒ‘ã‚¤ãƒ©ãƒ«æ¢ç´¢ï¼‰
            for (let p of projected) {
                let targetCol = Math.floor(p.normX * cols * 0.999);
                let targetRow = Math.floor(p.normY * rows * 0.999);
                targetCol = Math.max(0, Math.min(cols - 1, targetCol));
                targetRow = Math.max(0, Math.min(rows - 1, targetRow));
                
                let placed = false;
                for (let radius = 0; radius <= Math.max(cols, rows) && !placed; radius++) {
                    for (let dy = -radius; dy <= radius && !placed; dy++) {
                        for (let dx = -radius; dx <= radius && !placed; dx++) {
                            if (Math.abs(dx) !== radius && Math.abs(dy) !== radius) continue;
                            let c = targetCol + dx, r = targetRow + dy;
                            if (c >= 0 && c < cols && r >= 0 && r < rows) {
                                let key = `${c},${r}`;
                                if (!occupied.has(key)) {
                                    occupied.add(key);
                                    result.push({ topic: p.topic, gridX: c, gridY: r });
                                    placed = true;
                                }
                            }
                        }
                    }
                }
            }
            return result;
        }

        // ============================================
        // Topicã‚¯ãƒ©ã‚¹
        // è­°è«–ãƒˆãƒ”ãƒƒã‚¯ã‚’è¡¨ç¾ï¼ˆè«–æ–‡ã®å¼1ã«å¯¾å¿œï¼‰
        // ============================================
        class Topic {
            /**
             * @param {number} id - ãƒˆãƒ”ãƒƒã‚¯ID
             * @param {number} gridX - ã‚°ãƒªãƒƒãƒ‰ä¸Šã®Xä½ç½®
             * @param {number} gridY - ã‚°ãƒªãƒƒãƒ‰ä¸Šã®Yä½ç½®
             * @param {Object} newsgroup - ãƒˆãƒ”ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ï¼ˆname, weightsï¼‰
             */
            constructor(id, gridX, gridY, newsgroup) {
                this.id = id;
                this.gridX = gridX;
                this.gridY = gridY;
                this.name = newsgroup.name;
                
                // ãƒˆãƒ”ãƒƒã‚¯ãƒ™ã‚¯ãƒˆãƒ« T_n ã®ç”Ÿæˆï¼ˆå¼1ï¼‰
                // å…ƒã®é‡ã¿ã«å°ã•ãªãƒ©ãƒ³ãƒ€ãƒ å¤‰å‹•ã‚’åŠ ãˆã‚‹
                this.vector = newsgroup.weights.map(w => {
                    let varied = w + (Math.random() - 0.5) * 0.05;
                    return Math.max(0.01, Math.min(0.95, varied));
                });
                
                // æ­£è¦åŒ–ï¼ˆåˆè¨ˆãŒ1ã«ãªã‚‹ã‚ˆã†ã«ï¼‰
                let sum = this.vector.reduce((a, b) => a + b, 0);
                this.vector = this.vector.map(v => v / sum);
                
                // ä¸»è¦æ¬¡å…ƒï¼ˆæœ€å¤§é‡ã¿ã‚’æŒã¤æ¬¡å…ƒï¼‰ã‚’ç‰¹å®š
                this.primaryDim = this.vector.indexOf(Math.max(...this.vector));
                
                this.heat = 0;          // è¨ªå•ç†±ï¼ˆæœ€è¿‘è¨ªå•ã•ã‚ŒãŸã‹ã‚’ç¤ºã™ï¼‰
                this.visitCount = 0;    // è¨ªå•å›æ•°
            }
            
            /** ãƒˆãƒ”ãƒƒã‚¯ã«å…¥ã£ãŸæ™‚ã®å‡¦ç† */
            onEnter() { 
                this.heat = 1.0; 
                this.visitCount++; 
            }
            
            /** ç†±ã®æ¸›è¡°å‡¦ç†ï¼ˆæ¯ãƒ•ãƒ¬ãƒ¼ãƒ å‘¼ã°ã‚Œã‚‹ï¼‰ */
            coolDown() { 
                this.heat = Math.max(0, this.heat - heatDecayRate); 
            }
            
            /** çŸ­ç¸®åã‚’å–å¾—ï¼ˆä¾‹: "talk.politics.misc" â†’ "misc"ï¼‰ */
            getShortName() { 
                return this.name.split('.').pop(); 
            }
        }

        // ============================================
        // Memberã‚¯ãƒ©ã‚¹
        // ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¡ãƒ³ãƒãƒ¼ï¼ˆBoidï¼‰ã‚’è¡¨ç¾
        // è«–æ–‡ã®å¼2-5ã«å¯¾å¿œ
        // ============================================
        class Member {
            /**
             * @param {number} groupId - æ‰€å±ã‚°ãƒ«ãƒ¼ãƒ—ID
             * @param {number} memberId - ãƒ¡ãƒ³ãƒãƒ¼ID
             */
            constructor(groupId, memberId) {
                this.groupId = groupId;
                this.memberId = memberId;
                this.color = CONFIG.memberColors[memberId % CONFIG.memberColors.length];
                
                // ä½ç½®ãƒ»é€Ÿåº¦ãƒ»åŠ é€Ÿåº¦ãƒ™ã‚¯ãƒˆãƒ«ï¼ˆp5.jsã®Vectorä½¿ç”¨ï¼‰
                this.pos = createVector(0, 0);  // ä½ç½® p_i
                this.vel = createVector(0, 0);  // é€Ÿåº¦ v_i
                this.acc = createVector(0, 0);  // åŠ é€Ÿåº¦
                
                // ç§»å‹•ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆã‚·ãƒ³ã‚°ãƒ«ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¢ãƒ¼ãƒ‰ã§ã¯å¤§ããã™ã‚‹ï¼‰
                this.maxSpeed = singleGroupMode ? 1.4 : 0.9;
                this.maxForce = singleGroupMode ? 0.07 : 0.05;
                this.leftOut = false;  // é›¢è„±ãƒ•ãƒ©ã‚°
                
                // ============================================
                // æ½œåœ¨èˆˆå‘³ãƒ™ã‚¯ãƒˆãƒ« W_i ã®ç”Ÿæˆï¼ˆå¼2ï¼‰
                // ãƒ¡ãƒ³ãƒãƒ¼ã”ã¨ã«ç•°ãªã‚‹èˆˆå‘³ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒã¤
                // ============================================
                this.latentInterests = [];
                
                // ä¸»è¦èˆˆå‘³ï¼ˆæœ€ã‚‚èˆˆå‘³ã®ã‚ã‚‹æ¬¡å…ƒï¼‰ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠ
                this.primaryInterest = Math.floor(random(CONFIG.numDimensions));
                // å‰¯æ¬¡èˆˆå‘³ï¼ˆ2ç•ªç›®ã«èˆˆå‘³ã®ã‚ã‚‹æ¬¡å…ƒï¼‰
                this.secondaryInterest = (this.primaryInterest + Math.floor(random(1, CONFIG.numDimensions))) % CONFIG.numDimensions;
                
                // å„æ¬¡å…ƒã®èˆˆå‘³ãƒ¬ãƒ™ãƒ«ã‚’è¨­å®š
                for (let k = 0; k < CONFIG.numDimensions; k++) {
                    if (k === this.primaryInterest) {
                        // ä¸»è¦èˆˆå‘³: 45-60%
                        this.latentInterests.push(0.45 + Math.random() * 0.15);
                    } else if (k === this.secondaryInterest) {
                        // å‰¯æ¬¡èˆˆå‘³: 15-27%
                        this.latentInterests.push(0.15 + Math.random() * 0.12);
                    } else {
                        // ãã®ä»–: 2-10%
                        this.latentInterests.push(0.02 + Math.random() * 0.08);
                    }
                }
                
                // æ­£è¦åŒ–
                let sum = this.latentInterests.reduce((a, b) => a + b, 0);
                this.latentInterests = this.latentInterests.map(v => v / sum);
                
                this.currentInterest = 0;   // ç¾åœ¨ã®ãƒˆãƒ”ãƒƒã‚¯ã¸ã®èˆˆå‘³ u_in
                this.currentVelocity = 0;   // ç¾åœ¨ã®é€Ÿåº¦ v_i
            }
            
            /**
             * ãƒˆãƒ”ãƒƒã‚¯ã¸ã®èˆˆå‘³åº¦ã‚’è¨ˆç®—ï¼ˆå¼3ï¼‰
             * u_in = Î£(w_ik Ã— x_nk) - å†…ç©è¨ˆç®—
             * 
             * @param {Topic} topic - å¯¾è±¡ãƒˆãƒ”ãƒƒã‚¯
             * @returns {number} èˆˆå‘³åº¦
             */
            calculateInterest(topic) {
                let dotProduct = 0;
                for (let k = 0; k < CONFIG.numDimensions; k++) {
                    dotProduct += this.latentInterests[k] * topic.vector[k];
                }
                this.currentInterest = dotProduct * CONFIG.maxInterest;
                return this.currentInterest;
            }
            
            /**
             * é€Ÿåº¦ã‚’è¨ˆç®—ï¼ˆå¼5ï¼‰
             * v_i = Î± Ã— u_in Ã— V_max / L_max
             * 
             * @returns {number} é€Ÿåº¦
             */
            calculateVelocity() {
                this.currentVelocity = this.currentInterest * CONFIG.maxVelocity / CONFIG.maxInterest;
                return this.currentVelocity;
            }
            
            /** æ­£è¦åŒ–ã•ã‚ŒãŸèˆˆå‘³åº¦ï¼ˆ0-1ï¼‰ã‚’å–å¾— */
            getInterestNormalized() { 
                return this.currentInterest / CONFIG.maxInterest; 
            }
            
            /** åŠ›ã‚’åŠ ãˆã‚‹ */
            applyForce(force) { 
                this.acc.add(force); 
            }
            
            /**
             * èˆˆå‘³ã«åŸºã¥ãç§»å‹•æ–¹å‘ã‚’è¨ˆç®—
             * èˆˆå‘³ã®é«˜ã„ãƒˆãƒ”ãƒƒã‚¯ã«å‘ã‹ã†åŠ›ã‚’è¨ˆç®—
             * 
             * @param {Array} topics - ãƒˆãƒ”ãƒƒã‚¯é…åˆ—
             * @param {Object} bounds - å¢ƒç•Œ
             * @param {number} gridCols - ã‚°ãƒªãƒƒãƒ‰åˆ—æ•°
             * @param {number} gridRows - ã‚°ãƒªãƒƒãƒ‰è¡Œæ•°
             * @returns {p5.Vector} ç§»å‹•æ–¹å‘ãƒ™ã‚¯ãƒˆãƒ«
             */
            getPreferredDirection(topics, bounds, gridCols, gridRows) {
                let pullX = 0, pullY = 0, totalWeight = 0;
                let tileW = bounds.w / gridCols;
                let tileH = bounds.h / gridRows;
                
                for (let topic of topics) {
                    // ãƒˆãƒ”ãƒƒã‚¯ã¨ã®èˆˆå‘³ãƒãƒƒãƒåº¦ã‚’è¨ˆç®—
                    let match = 0;
                    for (let k = 0; k < CONFIG.numDimensions; k++) {
                        match += this.latentInterests[k] * topic.vector[k];
                    }
                    
                    let topicCenterX = bounds.x + (topic.gridX + 0.5) * tileW;
                    let topicCenterY = bounds.y + (topic.gridY + 0.5) * tileH;
                    
                    // ç†±ãƒšãƒŠãƒ«ãƒ†ã‚£ï¼ˆæœ€è¿‘è¨ªå•ã—ãŸãƒˆãƒ”ãƒƒã‚¯ã¯é¿ã‘ã‚‹ï¼‰
                    let heatPenalty = topic.heat * 0.7;
                    let weight = match * match * (1 - heatPenalty);
                    
                    // æœªè¨ªå•ãƒœãƒ¼ãƒŠã‚¹
                    if (topic.visitCount === 0) weight += 0.1;
                    weight = Math.max(0.01, weight);
                    
                    pullX += topicCenterX * weight;
                    pullY += topicCenterY * weight;
                    totalWeight += weight;
                }
                
                if (totalWeight > 0) {
                    let pull = createVector(pullX / totalWeight - this.pos.x, pullY / totalWeight - this.pos.y);
                    pull.normalize();
                    return pull;
                }
                return createVector(0, 0);
            }
            
            /**
             * Boids: çµåˆåŠ›ï¼ˆCohesionï¼‰
             * è¿‘éš£ã®ãƒ¡ãƒ³ãƒãƒ¼ã®ä¸­å¿ƒã«å‘ã‹ã†åŠ›
             * è«–æ–‡ã®ã€Œç¾¤ã‚Œã®ä¸­å¿ƒã«å‘ã‹ã†å‚¾å‘ã€ã«å¯¾å¿œ
             */
            cohesion(members) {
                let steering = createVector(0, 0);
                let total = 0;
                let radius = singleGroupMode ? 80 : 50;  // æ„ŸçŸ¥åŠå¾„
                
                for (let other of members) {
                    if (other !== this && !other.leftOut) {
                        let d = p5.Vector.dist(this.pos, other.pos);
                        if (d < radius && d > 0) { 
                            steering.add(other.pos); 
                            total++; 
                        }
                    }
                }
                if (total > 0) {
                    steering.div(total);
                    steering.sub(this.pos);
                    steering.setMag(this.maxSpeed);
                    steering.sub(this.vel);
                    steering.limit(this.maxForce);
                }
                return steering;
            }
            
            /**
             * Boids: æ•´åˆ—åŠ›ï¼ˆAlignmentï¼‰
             * è¿‘éš£ã®ãƒ¡ãƒ³ãƒãƒ¼ã¨åŒã˜æ–¹å‘ã«å‘ã‹ã†åŠ›
             * è«–æ–‡ã®ã€Œè­°è«–ã«ã¤ã„ã¦ã„ãæ„æ¬²ã€ã«å¯¾å¿œ
             */
            alignment(members) {
                let steering = createVector(0, 0);
                let total = 0;
                let radius = singleGroupMode ? 65 : 40;
                
                for (let other of members) {
                    if (other !== this && !other.leftOut) {
                        let d = p5.Vector.dist(this.pos, other.pos);
                        if (d < radius && d > 0) { 
                            steering.add(other.vel); 
                            total++; 
                        }
                    }
                }
                if (total > 0) {
                    steering.div(total);
                    steering.setMag(this.maxSpeed);
                    steering.sub(this.vel);
                    steering.limit(this.maxForce);
                }
                return steering;
            }
            
            /**
             * Boids: åˆ†é›¢åŠ›ï¼ˆSeparationï¼‰
             * è¿‘ã™ãã‚‹ãƒ¡ãƒ³ãƒãƒ¼ã‹ã‚‰é›¢ã‚Œã‚‹åŠ›
             * è«–æ–‡ã®ã€Œè‡ªåˆ†ã®èˆˆå‘³æ–¹å‘ã«ã‚·ãƒ•ãƒˆã™ã‚‹å‚¾å‘ã€ã«å¯¾å¿œ
             */
            separation(members) {
                let steering = createVector(0, 0);
                let radius = singleGroupMode ? 25 : 15;
                
                for (let other of members) {
                    if (other !== this) {
                        let d = p5.Vector.dist(this.pos, other.pos);
                        if (d < radius && d > 0) {
                            let diff = p5.Vector.sub(this.pos, other.pos);
                            diff.div(d);
                            steering.add(diff);
                        }
                    }
                }
                steering.limit(this.maxForce);
                return steering;
            }
            
            /**
             * Boidsã®3ã¤ã®åŠ›ã‚’çµ±åˆã—ã¦ç§»å‹•ã‚’è¨ˆç®—
             * èˆˆå‘³ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦åŠ›ã®å¼·ã•ã‚’èª¿æ•´
             */
            flock(members, topics, bounds, groupMomentum, gridCols, gridRows) {
                // é›¢è„±ãƒ¡ãƒ³ãƒãƒ¼ã¯å‹•ã‹ãªã„
                if (this.leftOut) { 
                    this.vel.set(0, 0); 
                    this.acc.set(0, 0); 
                    return; 
                }
                
                // 3ã¤ã®åŸºæœ¬åŠ›ã‚’è¨ˆç®—
                let coh = this.cohesion(members);
                let ali = this.alignment(members);
                let sep = this.separation(members);
                let pull = this.getPreferredDirection(topics, bounds, gridCols, gridRows);
                
                // èˆˆå‘³ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦åŠ›ã‚’èª¿æ•´ï¼ˆèˆˆå‘³ãŒé«˜ã„ã»ã©ç¾¤ã‚Œã«è¿½å¾“ã—ã‚„ã™ã„ï¼‰
                let interestNorm = this.getInterestNormalized();
                coh.mult(cohesionWeight * (0.4 + interestNorm * 0.6));
                ali.mult(alignmentWeight * (0.4 + interestNorm * 0.6));
                sep.mult(separationWeight);
                pull.mult(interestPullWeight * this.maxForce * (0.3 + interestNorm * 0.7));
                
                // ãƒ¢ãƒ¡ãƒ³ã‚¿ãƒ ï¼ˆæ…£æ€§ï¼‰
                let mom = groupMomentum.copy();
                mom.mult(momentumWeight * this.maxForce);
                
                // å…¨ã¦ã®åŠ›ã‚’é©ç”¨
                this.applyForce(coh);
                this.applyForce(ali);
                this.applyForce(sep);
                this.applyForce(pull);
                this.applyForce(mom);
                
                // å¢ƒç•Œã‹ã‚‰ã®åç™ºåŠ›
                let margin = 8, force = 0.08, b = bounds;
                if (this.pos.x < b.x + margin) this.applyForce(createVector(force, 0));
                if (this.pos.x > b.x + b.w - margin) this.applyForce(createVector(-force, 0));
                if (this.pos.y < b.y + margin) this.applyForce(createVector(0, force));
                if (this.pos.y > b.y + b.h - margin) this.applyForce(createVector(0, -force));
            }
            
            /** ä½ç½®ã®æ›´æ–° */
            update() {
                if (this.leftOut) return;
                
                this.vel.add(this.acc);
                
                // é€Ÿåº¦ã‚’èˆˆå‘³ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦åˆ¶é™
                let speedMult = map(this.currentVelocity, 0, CONFIG.maxVelocity, 0.4, 1.0);
                this.vel.limit(this.maxSpeed * speedMult);
                
                this.pos.add(this.vel);
                this.acc.mult(0);  // åŠ é€Ÿåº¦ã‚’ãƒªã‚»ãƒƒãƒˆ
            }
            
            /**
             * ãƒ¡ãƒ³ãƒãƒ¼ã®æç”»
             * - ã‚¢ã‚¯ãƒ†ã‚£ãƒ–: ä¸‰è§’å½¢ï¼ˆèˆˆå‘³ãƒ¬ãƒ™ãƒ«ã§å¤§ãã•å¤‰åŒ–ï¼‰
             * - é›¢è„±: ãƒ‘ãƒ«ã‚¹ã™ã‚‹å††ã¨â„ï¸ã‚¢ã‚¤ã‚³ãƒ³
             */
            draw(groupColor) {
                push();
                translate(this.pos.x, this.pos.y);
                
                // ã‚¹ã‚±ãƒ¼ãƒ«ä¿‚æ•°ï¼ˆã‚·ãƒ³ã‚°ãƒ«ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¢ãƒ¼ãƒ‰ã¯å¤§ããè¡¨ç¤ºï¼‰
                let scaleFactor = singleGroupMode ? 1.5 : 1.0;
                
                if (this.leftOut) {
                    // é›¢è„±ãƒ¡ãƒ³ãƒãƒ¼ã®æç”»ï¼ˆãƒ‘ãƒ«ã‚¹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
                    let pulse = sin(frameCount * 0.12) * 3 + 14 * scaleFactor;
                    noStroke(); 
                    fill(255, 60, 60, 40);
                    ellipse(0, 0, pulse + 8 * scaleFactor, pulse + 8 * scaleFactor);
                    fill(70, 70, 80); 
                    stroke(255, 80, 80); 
                    strokeWeight(2);
                    ellipse(0, 0, pulse, pulse);
                    stroke(255, 120, 120); 
                    strokeWeight(2);
                    let x = pulse * 0.22;
                    line(-x, -x, x, x); 
                    line(-x, x, x, -x);
                    fill(255); 
                    noStroke(); 
                    textSize(8 * scaleFactor); 
                    textAlign(CENTER, CENTER);
                    text('â„ï¸', 0, -pulse/2 - 5 * scaleFactor);
                } else {
                    // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¡ãƒ³ãƒãƒ¼ã®æç”»ï¼ˆä¸‰è§’å½¢ï¼‰
                    let interestNorm = this.getInterestNormalized();
                    let size = map(interestNorm, 0, 1, 4, 10) * scaleFactor;
                    let brightness = map(interestNorm, 0, 1, 0.35, 1.0);
                    
                    // ç§»å‹•æ–¹å‘ã«å›è»¢
                    if (this.vel.mag() > 0.05) rotate(this.vel.heading());
                    
                    let c = color(this.color);
                    fill(red(c) * brightness + 30, green(c) * brightness + 30, blue(c) * brightness + 30, 220);
                    stroke(red(c), green(c), blue(c));
                    strokeWeight(1.5 * scaleFactor);
                    
                    // ä¸‰è§’å½¢ã‚’æç”»
                    beginShape();
                    vertex(size, 0);
                    vertex(-size * 0.5, size * 0.5);
                    vertex(-size * 0.5, -size * 0.5);
                    endShape(CLOSE);
                }
                pop();
            }
        }

        // ============================================
        // Groupã‚¯ãƒ©ã‚¹
        // è­°è«–ã‚°ãƒ«ãƒ¼ãƒ—ã‚’è¡¨ç¾
        // ============================================
        class Group {
            /**
             * @param {number} id - ã‚°ãƒ«ãƒ¼ãƒ—ID
             * @param {Object} bounds - è¡¨ç¤ºé ˜åŸŸ {x, y, w, h}
             */
            constructor(id, bounds) {
                this.id = id;
                this.bounds = bounds;
                this.color = CONFIG.groupColors[id];
                this.members = [];
                this.topics = [];
                this.currentTopicIndex = 0;
                this.lastLeftOutCheck = 0;
                this.halted = false;  // ã‚°ãƒ«ãƒ¼ãƒ—åœæ­¢ãƒ•ãƒ©ã‚°
                
                this.momentum = createVector(0, 0);
                this.prevCentroid = null;
                
                // ã‚°ãƒªãƒƒãƒ‰ã‚µã‚¤ã‚ºï¼ˆãƒˆãƒ”ãƒƒã‚¯é…ç½®ç”¨ï¼‰
                if (singleGroupMode) {
                    this.gridCols = 5;
                    this.gridRows = 4;
                } else {
                    this.gridCols = 5;
                    this.gridRows = 4;
                }
                
                // èˆˆå‘³å±¥æ­´ï¼ˆã‚°ãƒ©ãƒ•è¡¨ç¤ºç”¨ï¼‰
                this.interestHistory = [];
                this.topicHistory = [];
                
                // ãƒˆãƒ”ãƒƒã‚¯ã‚’é¡ä¼¼åº¦ã«åŸºã¥ã„ã¦é…ç½®
                let arranged = arrangeTopicsByProjection(NEWSGROUP_TOPICS, this.gridCols, this.gridRows);
                for (let i = 0; i < arranged.length; i++) {
                    let a = arranged[i];
                    this.topics.push(new Topic(i, a.gridX, a.gridY, a.topic));
                }
                
                // ãƒ¡ãƒ³ãƒãƒ¼ã‚’ä¸­å¤®ä»˜è¿‘ã«ãƒ©ãƒ³ãƒ€ãƒ é…ç½®
                let centerX = bounds.x + bounds.w / 2;
                let centerY = bounds.y + bounds.h / 2;
                
                for (let i = 0; i < CONFIG.groupSize; i++) {
                    let member = new Member(id, i);
                    member.pos = createVector(centerX + random(-25, 25), centerY + random(-25, 25));
                    member.vel = p5.Vector.random2D().mult(0.2);
                    this.members.push(member);
                }
                
                this.centroid = createVector(centerX, centerY);
                this.prevCentroid = this.centroid.copy();
                
                // åˆæœŸãƒˆãƒ”ãƒƒã‚¯ã®è¨­å®š
                this.updateCurrentTopic();
                if (this.topics[this.currentTopicIndex]) {
                    this.topics[this.currentTopicIndex].onEnter();
                }
                this.updateMemberInterests();
                this.recordInterestSnapshot();
            }
            
            /**
             * èˆˆå‘³ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’è¨˜éŒ²ï¼ˆã‚°ãƒ©ãƒ•ç”¨ï¼‰
             */
            recordInterestSnapshot() {
                let snapshot = this.members.map(m => ({
                    interest: m.currentInterest,
                    leftOut: m.leftOut
                }));
                this.interestHistory.push(snapshot);
                this.topicHistory.push(this.currentTopicIndex + 1);
                
                // æœ€æ–°20ä»¶ã®ã¿ä¿æŒ
                if (this.interestHistory.length > 20) {
                    this.interestHistory.shift();
                    this.topicHistory.shift();
                }
            }
            
            /**
             * ã‚°ãƒ«ãƒ¼ãƒ—ã®é‡å¿ƒã‚’è¨ˆç®—
             * ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¡ãƒ³ãƒãƒ¼ã®å¹³å‡ä½ç½®
             */
            calculateCentroid() {
                let sumX = 0, sumY = 0, count = 0;
                for (let m of this.members) {
                    if (!m.leftOut) { 
                        sumX += m.pos.x; 
                        sumY += m.pos.y; 
                        count++; 
                    }
                }
                if (count > 0) {
                    this.prevCentroid = this.centroid.copy();
                    this.centroid.set(sumX / count, sumY / count);
                    
                    // ãƒ¢ãƒ¡ãƒ³ã‚¿ãƒ ã‚’æ›´æ–°ï¼ˆç§»å‹•æ–¹å‘ã®æ…£æ€§ï¼‰
                    let delta = p5.Vector.sub(this.centroid, this.prevCentroid);
                    this.momentum.lerp(delta, 0.15);
                    if (this.momentum.mag() > 0.01) this.momentum.normalize();
                }
            }
            
            /**
             * ç¾åœ¨ã®ãƒˆãƒ”ãƒƒã‚¯ã‚’æ›´æ–°
             * é‡å¿ƒã®ä½ç½®ã‹ã‚‰å¯¾å¿œã™ã‚‹ãƒˆãƒ”ãƒƒã‚¯ã‚’ç‰¹å®š
             */
            updateCurrentTopic() {
                let b = this.bounds;
                let tileW = b.w / this.gridCols;
                let tileH = b.h / this.gridRows;
                
                let col = constrain(Math.floor((this.centroid.x - b.x) / tileW), 0, this.gridCols - 1);
                let row = constrain(Math.floor((this.centroid.y - b.y) / tileH), 0, this.gridRows - 1);
                
                let newTopic = this.topics.find(t => t.gridX === col && t.gridY === row);
                
                // ãƒˆãƒ”ãƒƒã‚¯ãŒå¤‰ã‚ã£ãŸå ´åˆ
                if (newTopic && newTopic.id !== this.currentTopicIndex) {
                    this.currentTopicIndex = newTopic.id;
                    newTopic.onEnter();
                    totalTopicChanges++;
                    this.updateMemberInterests();
                    this.checkLeftOut();
                    this.recordInterestSnapshot();
                }
            }
            
            /** ç¾åœ¨ã®ãƒˆãƒ”ãƒƒã‚¯ã‚’å–å¾— */
            getCurrentTopic() { 
                return this.topics[this.currentTopicIndex] || this.topics[0]; 
            }
            
            /**
             * å…¨ãƒ¡ãƒ³ãƒãƒ¼ã®èˆˆå‘³åº¦ã‚’æ›´æ–°
             * ç¾åœ¨ã®ãƒˆãƒ”ãƒƒã‚¯ã«å¯¾ã™ã‚‹èˆˆå‘³ã‚’å†è¨ˆç®—
             */
            updateMemberInterests() {
                let topic = this.getCurrentTopic();
                for (let m of this.members) { 
                    m.calculateInterest(topic); 
                    m.calculateVelocity(); 
                }
            }
            
            /**
             * ã‚°ãƒ«ãƒ¼ãƒ—ã®å¹³å‡é€Ÿåº¦ã‚’è¨ˆç®—ï¼ˆå¼6ï¼‰
             * v_G = Î£(v_i) / I
             */
            getGroupVelocity() {
                let sum = 0, count = 0;
                for (let m of this.members) { 
                    if (!m.leftOut) { 
                        sum += m.currentVelocity; 
                        count++; 
                    } 
                }
                return count > 0 ? sum / count : 0;
            }
            
            /**
             * é›¢è„±ãƒ¡ãƒ³ãƒãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆå¼7ï¼‰
             * v_i_lb = v_G - v_i > vâ‚€ ãªã‚‰é›¢è„±
             */
            checkLeftOut() {
                let vG = this.getGroupVelocity();
                
                for (let m of this.members) {
                    if (!m.leftOut) {
                        // é›¢è„±é€Ÿåº¦ã‚’è¨ˆç®—
                        let v_lb = vG - m.currentVelocity;
                        
                        // é–¾å€¤ã‚’è¶…ãˆãŸã‚‰é›¢è„±
                        if (v_lb > leftOutThreshold) {
                            m.leftOut = true;
                            let entry = `[${CONFIG.groupNames[this.id]}] M${m.memberId+1}: v_lb=${v_lb.toFixed(2)}`;
                            leftOutLog.unshift(entry);
                            if (leftOutLog.length > 15) leftOutLog.pop();
                        }
                    }
                }
                
                // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¡ãƒ³ãƒãƒ¼ãŒå°‘ãªã™ãã‚‹å ´åˆã¯ã‚°ãƒ«ãƒ¼ãƒ—ã‚’åœæ­¢
                if (this.getActiveCount() < CONFIG.minActiveMembers) {
                    this.halted = true;
                }
            }
            
            /** ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¡ãƒ³ãƒãƒ¼æ•°ã‚’å–å¾— */
            getActiveCount() { 
                return this.members.filter(m => !m.leftOut).length; 
            }
            
            /** é›¢è„±ãƒ¡ãƒ³ãƒãƒ¼æ•°ã‚’å–å¾— */
            getLeftOutCount() { 
                return this.members.filter(m => m.leftOut).length; 
            }
            
            /**
             * ã‚°ãƒ«ãƒ¼ãƒ—ã®æ›´æ–°å‡¦ç†ï¼ˆæ¯ãƒ•ãƒ¬ãƒ¼ãƒ å‘¼ã°ã‚Œã‚‹ï¼‰
             */
            update() {
                // åœæ­¢ä¸­ã¯æ›´æ–°ã—ãªã„
                if (this.halted) return;
                
                // ãƒˆãƒ”ãƒƒã‚¯ã®ç†±ã‚’æ¸›è¡°
                for (let t of this.topics) t.coolDown();
                
                // å®šæœŸçš„ã«é›¢è„±ãƒã‚§ãƒƒã‚¯
                if (frameCount - this.lastLeftOutCheck >= leftOutCheckFrequency) {
                    this.updateMemberInterests();
                    this.checkLeftOut();
                    this.lastLeftOutCheck = frameCount;
                }
                
                // å„ãƒ¡ãƒ³ãƒãƒ¼ã®æ›´æ–°
                for (let m of this.members) {
                    m.flock(this.members, this.topics, this.bounds, this.momentum, this.gridCols, this.gridRows);
                    m.update();
                    
                    // å¢ƒç•Œå†…ã«åã‚ã‚‹
                    if (!m.leftOut) {
                        m.pos.x = constrain(m.pos.x, this.bounds.x + 5, this.bounds.x + this.bounds.w - 5);
                        m.pos.y = constrain(m.pos.y, this.bounds.y + 5, this.bounds.y + this.bounds.h - 5);
                    }
                }
                
                this.calculateCentroid();
                this.updateCurrentTopic();
            }
            
            /**
             * ã‚°ãƒ«ãƒ¼ãƒ—ã®æç”»
             */
            draw() {
                let b = this.bounds;
                let tileW = b.w / this.gridCols;
                let tileH = b.h / this.gridRows;
                
                // ã‚¹ã‚±ãƒ¼ãƒ«ä¿‚æ•°
                let scaleFactor = singleGroupMode ? 1.8 : 1.0;
                
                // ãƒˆãƒ”ãƒƒã‚¯ã‚°ãƒªãƒƒãƒ‰ã‚’æç”»
                for (let topic of this.topics) {
                    let x = b.x + topic.gridX * tileW;
                    let y = b.y + topic.gridY * tileH;
                    let isCurrent = topic.id === this.currentTopicIndex;
                    
                    let primaryColor = color(CONFIG.dimensionColors[topic.primaryDim]);
                    
                    if (isCurrent) {
                        // ç¾åœ¨ã®ãƒˆãƒ”ãƒƒã‚¯ã¯æ˜ã‚‹ãè¡¨ç¤º
                        fill(red(primaryColor) * 0.35, green(primaryColor) * 0.35, blue(primaryColor) * 0.35);
                        stroke(red(primaryColor), green(primaryColor), blue(primaryColor));
                        strokeWeight(2 * scaleFactor);
                    } else {
                        let shade = topic.heat > 0.3 ? 0.18 : 0.12;
                        fill(red(primaryColor) * shade, green(primaryColor) * shade, blue(primaryColor) * shade);
                        stroke(red(primaryColor) * 0.3, green(primaryColor) * 0.3, blue(primaryColor) * 0.3);
                        strokeWeight(1);
                    }
                    
                    rect(x, y, tileW, tileH);
                    
                    // ãƒˆãƒ”ãƒƒã‚¯åã‚’è¡¨ç¤º
                    fill(isCurrent ? 255 : 100);
                    noStroke();
                    textSize(5 * scaleFactor);
                    textAlign(CENTER, CENTER);
                    let nameLen = singleGroupMode ? 8 : 5;
                    text(topic.getShortName().substr(0, nameLen), x + tileW/2, y + tileH/2);
                }
                
                // ã‚°ãƒ«ãƒ¼ãƒ—ã®å¢ƒç•Œç·š
                noFill(); 
                stroke(this.halted ? color(255, 80, 80) : color(80, 90, 110)); 
                strokeWeight(this.halted ? 3 : 2);
                rect(b.x, b.y, b.w, b.h, 3);
                
                // é‡å¿ƒã‚’è¡¨ç¤º
                if (!this.halted) {
                    stroke(255, 255, 255, 200); 
                    strokeWeight(2 * scaleFactor); 
                    noFill();
                    ellipse(this.centroid.x, this.centroid.y, 8 * scaleFactor, 8 * scaleFactor);
                }
                
                // ãƒ¡ãƒ³ãƒãƒ¼ã‚’æç”»ï¼ˆã‚¢ã‚¯ãƒ†ã‚£ãƒ–â†’é›¢è„±ã®é †ã§æç”»ï¼‰
                for (let m of this.members) if (!m.leftOut) m.draw(this.color);
                for (let m of this.members) if (m.leftOut) m.draw(this.color);
                
                // ã‚°ãƒ«ãƒ¼ãƒ—ãƒ©ãƒ™ãƒ«
                fill(255); 
                noStroke(); 
                textSize(7 * scaleFactor); 
                textAlign(LEFT, TOP);
                text(CONFIG.groupNames[this.id], b.x + 3, b.y + 2);
                
                // é›¢è„±è€…æ•°ã‚’è¡¨ç¤º
                let frozen = this.getLeftOutCount();
                if (frozen > 0) {
                    fill(255, 100, 100);
                    text(`â„ï¸${frozen}`, b.x + 16 * scaleFactor, b.y + 2);
                }
                
                // åœæ­¢ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
                if (this.halted) {
                    fill(60, 20, 20, 200);
                    rect(b.x, b.y, b.w, b.h);
                    fill(255, 100, 100);
                    textSize(9 * scaleFactor);
                    textAlign(CENTER, CENTER);
                    text('â›” HALTED', b.x + b.w/2, b.y + b.h/2 - 6 * scaleFactor);
                    textSize(6 * scaleFactor);
                    fill(200);
                    text(`< ${CONFIG.minActiveMembers} active`, b.x + b.w/2, b.y + b.h/2 + 5 * scaleFactor);
                }
            }
        }

        // ============================================
        // ã‚°ãƒ©ãƒ•æç”»é–¢æ•°
        // HTML Canvas APIã‚’ä½¿ç”¨ï¼ˆé«˜DPIãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤å¯¾å¿œï¼‰
        // è«–æ–‡ã®å›³5ã«ç›¸å½“ã™ã‚‹ç©ã¿ä¸Šã’é¢ã‚°ãƒ©ãƒ•ã‚’æç”»
        // ============================================
        
        /**
         * ã‚°ãƒ©ãƒ•ã‚­ãƒ£ãƒ³ãƒã‚¹ã®åˆæœŸè¨­å®š
         * é«˜DPIãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤å¯¾å¿œã®ãŸã‚ã®ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°
         */
        function setupGraphCanvas() {
            const canvas = document.getElementById('graph-canvas');
            const dpr = window.devicePixelRatio || 1;  // ãƒ‡ãƒã‚¤ã‚¹ãƒ”ã‚¯ã‚»ãƒ«æ¯”
            const displayWidth = 640;
            const displayHeight = 160;
            
            // å®Ÿéš›ã®ãƒ”ã‚¯ã‚»ãƒ«æ•°ã‚’å¢—ã‚„ã™ï¼ˆRetinaãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤å¯¾å¿œï¼‰
            canvas.width = displayWidth * dpr;
            canvas.height = displayHeight * dpr;
            
            // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚¹ã‚±ãƒ¼ãƒ«
            const ctx = canvas.getContext('2d');
            ctx.scale(dpr, dpr);
            
            return { canvas, ctx, W: displayWidth, H: displayHeight };
        }
        
        let graphSetup = null;
        
        /**
         * èˆˆå‘³å¤‰å‹•ã‚°ãƒ©ãƒ•ã®æç”»
         * ç©ã¿ä¸Šã’é¢ã‚°ãƒ©ãƒ•ã§ãƒ¡ãƒ³ãƒãƒ¼ã®èˆˆå‘³å¤‰å‹•ã‚’å¯è¦–åŒ–
         */
        function drawInterestGraph() {
            // åˆå›ã®ã¿ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
            if (!graphSetup) {
                graphSetup = setupGraphCanvas();
            }
            
            const { ctx, W, H } = graphSetup;
            
            // èƒŒæ™¯ã‚’ã‚¯ãƒªã‚¢
            ctx.fillStyle = '#0f0f1a';
            ctx.fillRect(0, 0, W, H);
            
            let group = groups[selectedGroupId];
            if (!group) return;
            
            let history = group.interestHistory;
            let topicLabels = group.topicHistory;
            
            // ãƒ‡ãƒ¼ã‚¿ãŒå°‘ãªã„å ´åˆã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            if (history.length < 2) {
                ctx.fillStyle = '#666';
                ctx.font = '12px Segoe UI';
                ctx.textAlign = 'center';
                ctx.fillText('ğŸ“ˆ Waiting for topic transitions...', W/2, H/2);
                return;
            }
            
            // ã‚°ãƒ©ãƒ•ã®ãƒãƒ¼ã‚¸ãƒ³è¨­å®š
            const margin = { left: 45, right: 15, top: 20, bottom: 25 };
            const plotW = W - margin.left - margin.right;
            const plotH = H - margin.top - margin.bottom;
            
            const numPoints = history.length;
            const maxY = CONFIG.groupSize * CONFIG.maxInterest;  // Yè»¸ã®æœ€å¤§å€¤
            
            // ã‚¿ã‚¤ãƒˆãƒ«æç”»
            ctx.fillStyle = CONFIG.groupColors[selectedGroupId];
            ctx.font = 'bold 11px Segoe UI';
            ctx.textAlign = 'left';
            let titlePrefix = singleGroupMode ? 'Single Group' : CONFIG.groupNames[selectedGroupId];
            ctx.fillText(`${titlePrefix} - Interest Fluctuation`, margin.left, 14);
            
            if (group.halted) {
                ctx.fillStyle = '#ff5555';
                ctx.fillText(' [HALTED]', margin.left + 140, 14);
            }
            
            // è»¸ã‚’æç”»
            ctx.strokeStyle = '#444';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(margin.left, margin.top);
            ctx.lineTo(margin.left, margin.top + plotH);
            ctx.lineTo(margin.left + plotW, margin.top + plotH);
            ctx.stroke();
            
            // Yè»¸ãƒ©ãƒ™ãƒ«ã¨ã‚°ãƒªãƒƒãƒ‰ç·š
            ctx.fillStyle = '#888';
            ctx.font = '9px Segoe UI';
            ctx.textAlign = 'right';
            for (let i = 0; i <= 4; i++) {
                let y = margin.top + plotH - (i / 4) * plotH;
                let val = (i / 4) * maxY;
                ctx.fillText(val.toFixed(0), margin.left - 5, y + 3);
                
                ctx.strokeStyle = '#333';
                ctx.beginPath();
                ctx.moveTo(margin.left, y);
                ctx.lineTo(margin.left + plotW, y);
                ctx.stroke();
            }
            
            // Xè»¸ãƒ©ãƒ™ãƒ«ï¼ˆãƒˆãƒ”ãƒƒã‚¯ç•ªå·ï¼‰
            ctx.textAlign = 'center';
            let step = Math.max(1, Math.floor(numPoints / 10));
            for (let i = 0; i < numPoints; i += step) {
                let x = margin.left + (i / (numPoints - 1)) * plotW;
                ctx.fillStyle = '#888';
                ctx.fillText('t' + topicLabels[i], x, margin.top + plotH + 12);
            }
            
            // ç©ã¿ä¸Šã’é¢ã‚°ãƒ©ãƒ•ã‚’æç”»ï¼ˆä¸‹ã‹ã‚‰ä¸Šã¸ï¼‰
            for (let m = CONFIG.groupSize - 1; m >= 0; m--) {
                ctx.beginPath();
                
                // ä¸‹ç«¯ã®ç·šã‚’æç”»
                for (let i = 0; i < numPoints; i++) {
                    let x = margin.left + (i / (numPoints - 1)) * plotW;
                    let cumulative = 0;
                    // ã“ã®ãƒ¡ãƒ³ãƒãƒ¼ã‚ˆã‚Šä¸‹ã®ãƒ¡ãƒ³ãƒãƒ¼ã®èˆˆå‘³ã‚’ç´¯ç©
                    for (let j = m + 1; j < CONFIG.groupSize; j++) {
                        if (!history[i][j].leftOut) {
                            cumulative += history[i][j].interest;
                        }
                    }
                    let y = margin.top + plotH - (cumulative / maxY) * plotH;
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                
                // ä¸Šç«¯ã®ç·šã‚’æç”»ï¼ˆé€†é †ï¼‰
                for (let i = numPoints - 1; i >= 0; i--) {
                    let x = margin.left + (i / (numPoints - 1)) * plotW;
                    let cumulative = 0;
                    // ã“ã®ãƒ¡ãƒ³ãƒãƒ¼ã‚’å«ã‚€ç´¯ç©
                    for (let j = m; j < CONFIG.groupSize; j++) {
                        if (!history[i][j].leftOut) {
                            cumulative += history[i][j].interest;
                        }
                    }
                    let y = margin.top + plotH - (cumulative / maxY) * plotH;
                    ctx.lineTo(x, y);
                }
                
                ctx.closePath();
                
                // åŠé€æ˜ã®å¡—ã‚Šã¤ã¶ã—
                let c = CONFIG.memberColors[m];
                ctx.fillStyle = c + '99';  // ã‚¢ãƒ«ãƒ•ã‚¡å€¤ã‚’è¿½åŠ 
                ctx.fill();
                
                // å¢ƒç•Œç·š
                ctx.strokeStyle = c;
                ctx.lineWidth = 1;
                ctx.stroke();
            }
            
            // Yè»¸ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆç¸¦æ›¸ãï¼‰
            ctx.save();
            ctx.translate(12, margin.top + plotH / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillStyle = '#aaa';
            ctx.font = '9px Segoe UI';
            ctx.textAlign = 'center';
            ctx.fillText('Cumulative Interest', 0, 0);
            ctx.restore();
            
            // Xè»¸ã‚¿ã‚¤ãƒˆãƒ«
            ctx.fillStyle = '#aaa';
            ctx.font = '9px Segoe UI';
            ctx.textAlign = 'center';
            ctx.fillText('Topic Transitions', margin.left + plotW / 2, H - 5);
        }

        // ============================================
        // p5.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—é–¢æ•°
        // åˆæœŸåŒ–å‡¦ç†
        // ============================================
        function setup() {
            // ãƒ¡ã‚¤ãƒ³ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ä½œæˆ
            let canvas = createCanvas(640, 320);
            canvas.parent('canvas-container');
            canvas.id('simulation-canvas');
            
            initSimulation();
            setupEventListeners();
            updateLegend();
        }
        
        /**
         * ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–
         * ã‚°ãƒ«ãƒ¼ãƒ—ã¨ãƒ¡ãƒ³ãƒãƒ¼ã‚’ç”Ÿæˆ
         */
        function initSimulation() {
            groups = [];
            totalTopicChanges = 0;
            leftOutLog = [];
            selectedGroupId = 0;
            
            let padding = 4, gap = 4;
            
            if (singleGroupMode) {
                // ã‚·ãƒ³ã‚°ãƒ«ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¢ãƒ¼ãƒ‰: å…¨ç”»é¢ã‚’1ã‚°ãƒ«ãƒ¼ãƒ—ã§ä½¿ç”¨
                let gw = width - padding * 2;
                let gh = height - padding * 2;
                groups.push(new Group(0, { x: padding, y: padding, w: gw, h: gh }));
                
                // G1ä»¥å¤–ã®ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
                document.querySelectorAll('.group-btn').forEach((btn, i) => {
                    btn.style.display = i === 0 ? 'block' : 'none';
                });
                document.querySelector('.group-btn.g1').classList.add('active');
            } else {
                // 4ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¢ãƒ¼ãƒ‰: 2x2ã‚°ãƒªãƒƒãƒ‰ã§é…ç½®
                let gw = (width - padding * 2 - gap) / 2;
                let gh = (height - padding * 2 - gap) / 2;
                
                groups.push(new Group(0, { x: padding, y: padding, w: gw, h: gh }));
                groups.push(new Group(1, { x: padding + gw + gap, y: padding, w: gw, h: gh }));
                groups.push(new Group(2, { x: padding, y: padding + gh + gap, w: gw, h: gh }));
                groups.push(new Group(3, { x: padding + gw + gap, y: padding + gh + gap, w: gw, h: gh }));
                
                // å…¨ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                document.querySelectorAll('.group-btn').forEach(btn => {
                    btn.style.display = 'block';
                });
            }
            
            updateModeButton();
            updateUI();
        }
        
        /** ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–° */
        function updateModeButton() {
            const btn = document.getElementById('mode-btn');
            if (singleGroupMode) {
                btn.textContent = 'ğŸ”„ Switch to 4 Groups';
            } else {
                btn.textContent = 'ğŸ”„ Switch to 1 Group';
            }
        }
        
        /** ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿å‡¦ç† */
        function toggleMode() {
            singleGroupMode = !singleGroupMode;
            initSimulation();
        }
        
        /** ã‚°ãƒ©ãƒ•å‡¡ä¾‹ã‚’æ›´æ–° */
        function updateLegend() {
            let legendHtml = '';
            for (let i = 0; i < CONFIG.groupSize; i++) {
                legendHtml += `<span class="legend-item"><span class="legend-color" style="background:${CONFIG.memberColors[i]}"></span>M${i+1}</span>`;
            }
            document.getElementById('graph-legend').innerHTML = legendHtml;
        }
        
        /**
         * ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
         * ãƒœã‚¿ãƒ³ã¨ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å‹•ä½œã‚’å®šç¾©
         */
        function setupEventListeners() {
            // ã‚°ãƒ«ãƒ¼ãƒ—é¸æŠãƒœã‚¿ãƒ³
            document.querySelectorAll('.group-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.group-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    selectedGroupId = parseInt(btn.dataset.group);
                    updateUI();
                });
            });
            
            // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼è¨­å®š
            const sliders = [
                ['threshold', v => { leftOutThreshold = v; document.getElementById('v0-display').textContent = v.toFixed(2); }],
                ['check-freq', v => leftOutCheckFrequency = v],
                ['cohesion', v => cohesionWeight = v],
                ['alignment', v => alignmentWeight = v],
                ['separation', v => separationWeight = v],
                ['interest-pull', v => interestPullWeight = v],
            ];
            
            sliders.forEach(([id, fn]) => {
                let el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', (e) => {
                        let v = parseFloat(e.target.value);
                        fn(v);
                        let valEl = document.getElementById(id + '-val');
                        if (valEl) valEl.textContent = v.toFixed(id === 'check-freq' ? 0 : 2);
                    });
                }
            });
            
            // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³
            document.getElementById('mode-btn').addEventListener('click', toggleMode);
            document.getElementById('restart-btn').addEventListener('click', initSimulation);
            document.getElementById('pause-btn').addEventListener('click', () => {
                paused = !paused;
                document.getElementById('pause-btn').textContent = paused ? 'â–¶ï¸ Resume' : 'â¸ï¸ Pause';
            });
            document.getElementById('force-check-btn').addEventListener('click', () => {
                for (let g of groups) { 
                    g.updateMemberInterests(); 
                    g.checkLeftOut(); 
                }
                updateUI();
            });
        }

        // ============================================
        // ãƒ¡ã‚¤ãƒ³æç”»ãƒ«ãƒ¼ãƒ—
        // p5.jsã«ã‚ˆã‚Šæ¯ãƒ•ãƒ¬ãƒ¼ãƒ å‘¼ã°ã‚Œã‚‹
        // ============================================
        function draw() {
            background(15, 15, 22);
            
            // ä¸€æ™‚åœæ­¢ä¸­ã§ãªã‘ã‚Œã°æ›´æ–°
            if (!paused) {
                for (let g of groups) g.update();
            }
            
            // å…¨ã‚°ãƒ«ãƒ¼ãƒ—ã‚’æç”»
            for (let g of groups) g.draw();
            
            // ã‚°ãƒ©ãƒ•ã‚’æç”»
            drawInterestGraph();
            
            // 8ãƒ•ãƒ¬ãƒ¼ãƒ ã”ã¨ã«UIã‚’æ›´æ–°
            if (frameCount % 8 === 0) updateUI();
        }

        /**
         * UIè¦ç´ ã‚’æ›´æ–°
         * ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã€çµ±è¨ˆæƒ…å ±ãªã©ã‚’æœ€æ–°çŠ¶æ…‹ã«
         */
        function updateUI() {
            let group = groups[selectedGroupId];
            let topic = group.getCurrentTopic();
            let vG = group.getGroupVelocity();
            
            // ãƒˆãƒ”ãƒƒã‚¯æƒ…å ±ã‚’æ›´æ–°
            document.getElementById('topic-name').textContent = topic.name;
            document.getElementById('topic-category').textContent = `Primary: ${CONFIG.dimensionNames[topic.primaryDim]}`;
            document.getElementById('vg-display').textContent = vG.toFixed(2);
            
            // ãƒˆãƒ”ãƒƒã‚¯ã®æ¬¡å…ƒãƒãƒ¼ã‚’æ›´æ–°
            let dimHtml = '';
            for (let k = 0; k < CONFIG.numDimensions; k++) {
                let pct = (topic.vector[k] * 100).toFixed(0);
                dimHtml += `
                    <div class="dimension-bar">
                        <span class="label">${CONFIG.dimensionNames[k]}</span>
                        <div class="bar-track">
                            <div class="bar-fill" style="width:${pct}%; background:${CONFIG.dimensionColors[k]}"></div>
                        </div>
                        <span class="value">${pct}%</span>
                    </div>
                `;
            }
            document.getElementById('topic-dimensions').innerHTML = dimHtml;
            
            // ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã‚’æ›´æ–°ï¼ˆé€Ÿåº¦é †ã«ã‚½ãƒ¼ãƒˆï¼‰
            let memberHtml = '';
            let sorted = [...group.members].sort((a, b) => b.currentVelocity - a.currentVelocity);
            
            for (let m of sorted) {
                let intPct = (m.getInterestNormalized() * 100).toFixed(0);
                let v_lb = vG - m.currentVelocity;
                let wouldFreeze = v_lb > leftOutThreshold && !m.leftOut;
                
                // çŠ¶æ…‹ã«å¿œã˜ãŸCSSã‚¯ãƒ©ã‚¹ã‚’è¨­å®š
                let cls = m.leftOut ? 'left-out' : (parseFloat(intPct) > 50 ? 'high-interest' : (parseFloat(intPct) < 30 ? 'low-interest' : ''));
                let status = m.leftOut ? 'â„ï¸' : (wouldFreeze ? 'âš ï¸' : '');
                
                memberHtml += `
                    <div class="member-item ${cls}">
                        <span style="font-weight:bold; color:${m.color}">M${m.memberId+1}</span>
                        <span style="font-size:0.45rem; color:#888">${CONFIG.dimensionNames[m.primaryInterest].substr(0,3)}</span>
                        <div class="interest-bar">
                            <div class="interest-fill" style="width:${intPct}%; background:${m.color}"></div>
                        </div>
                        <span style="font-size:0.43rem; font-family:monospace">${intPct}%</span>
                        <span>${status}</span>
                    </div>
                `;
            }
            document.getElementById('member-list').innerHTML = memberHtml;
            
            // é›¢è„±ãƒ­ã‚°ã‚’æ›´æ–°
            document.getElementById('leftout-log').innerHTML = leftOutLog.length > 0 ? leftOutLog.join('<br>') : 'Waiting...';
            
            // çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
            let totalActive = 0, totalLeftOut = 0, haltedCount = 0;
            for (let g of groups) { 
                totalActive += g.getActiveCount(); 
                totalLeftOut += g.getLeftOutCount();
                if (g.halted) haltedCount++;
            }
            document.getElementById('total-active').textContent = totalActive;
            document.getElementById('total-leftout').textContent = totalLeftOut;
            document.getElementById('topic-changes').textContent = totalTopicChanges;
            document.getElementById('halted-count').textContent = haltedCount;
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤ºã‚’æ›´æ–°
            const modeText = singleGroupMode ? '1 Group Mode' : '4 Groups Mode';
            document.querySelector('.header p').textContent = `${modeText} â€¢ Group halts when <3 active members â€¢ Graph shows interest fluctuation`;
        }
    </script>
</body>
</html>
